<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å¯†ç æœ¬</title>
    <link rel="stylesheet" href="./pwd-list-style.css">
</head>

<body>
    <!-- notyfèµ„æºæŒ‚è½½ -->
    <link rel="stylesheet" href="node_modules/notyf/notyf.min.css">
    <div id="list">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <!-- å›ºå®šæµ®åŠ¨æŒ‰é’® -->
    <div class="fab-container" id="fabAdd">
        <div class="fab-button">+</div>
    </div>
    
    <!-- å¯¼å‡ºæŒ‰é’® -->
    <div class="fab-container" id="fabExport">
        <div class="fab-button">â¤“</div>
    </div>
    
    <!-- å¯¼å…¥æŒ‰é’® -->
    <div class="fab-container" id="fabImport">
        <div class="fab-button">â¤’</div>
    </div>
    <!-- <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // åœ¨è¿™é‡Œå¤„ç†â€œåŠ è½½é¡µé¢â€äº‹ä»¶ï¼Œæ¯”å¦‚ä»æœåŠ¡å™¨è·å–æ•°æ®
            // ä¸»åŠ¨è¯·æ±‚å‘èµ·æ•°æ®
            await  window.electronAPI.loadPasswordList(); // å¯æ ¹æ®å…·ä½“å®ç°ä¿®æ”¹
        });
    </script> -->
    <script>
        document.getElementById('fabAdd').addEventListener('click', () => {
            // åœ¨è¿™é‡Œå¤„ç†â€œæ·»åŠ å¯†ç â€äº‹ä»¶ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ªIPCçª—å£æˆ–å¼¹çª—
            window.electronAPI.openAddPasswordWindow(null); // å¯æ ¹æ®å…·ä½“å®ç°ä¿®æ”¹
        });
        
        // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('fabExport').addEventListener('click', async () => {
            try {
                // è·å–å¯†ç åˆ—è¡¨
                const store = await window.electronAPI.showStore();
                const passwordRecords = store.pwdRecords || [];
                
                if (passwordRecords.length === 0) {
                    window.electronAPI.showTip('error', 'æ²¡æœ‰å¯å¯¼å‡ºçš„å¯†ç è®°å½•');
                    return;
                }
                
                // è°ƒç”¨ä¸»è¿›ç¨‹çš„å¯¼å‡ºåŠŸèƒ½
                const result = await window.electronAPI.exportPasswords(passwordRecords);
                if (result) {
                    window.electronAPI.showTip('success', 'å¯†ç å¯¼å‡ºæˆåŠŸ');
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¯†ç å¤±è´¥:', error);
                window.electronAPI.showTip('error', 'å¯¼å‡ºå¯†ç å¤±è´¥');
            }
        });
        
        // å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('fabImport').addEventListener('click', async () => {
            try {
                // è°ƒç”¨ä¸»è¿›ç¨‹çš„å¯¼å…¥åŠŸèƒ½
                const result = await window.electronAPI.importPasswords();
                if (result) {
                    window.electronAPI.showTip('success', 'å¯†ç å¯¼å…¥æˆåŠŸ');
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°å¯¼å…¥çš„å¯†ç 
                    location.reload();
                }
            } catch (error) {
                console.error('å¯¼å…¥å¯†ç å¤±è´¥:', error);
                window.electronAPI.showTip('error', 'å¯¼å…¥å¯†ç å¤±è´¥');
            }
        });
    </script>
    <script type="module">
        // FIX:å·¦æ‹¬å·< æ³¨å…¥BUG
        function escapeHtml(str) {
            if (typeof str !== 'string') return str;
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/`/g, '&#096;');
        }
        // è§„åˆ™æ ‡ç­¾åç§°è½¬æ¢
        const ruleLabels = {
            uppercaseChars: 'å¤§å†™',
            lowercaseChars: 'å°å†™',
            numberChars: 'æ•°å­—',
            symbolChars: 'ç¬¦å·',
            custom: 'è‡ªå®šä¹‰',
        };
        const container = document.getElementById('list');
        container.innerHTML = '';

        let list = await window.electronAPI.showStore();
        list = list.pwdRecords
        console.log('æŸ¥çœ‹list', list);
        if (!list || list.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'empty-state ';
            placeholder.innerText = 'æš‚æœªä¿å­˜å¯†ç è®°å½•';
            container.appendChild(placeholder);
        } else {
            list.forEach(item => {
                const content = escapeHtml(item.content);
                const createTime = escapeHtml(item.createTime);
                const id = escapeHtml(item.id);
                const rules = escapeHtml(item.rules.map(ruleKey => ruleLabels[ruleKey]).join(', '))
                const lengthMin = escapeHtml(String(item.length.minLength));
                const lengthMax = escapeHtml(String(item.length.maxLength));
                const url = escapeHtml(item.url ? item.url : '');

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                <div class="card-header">
                    <div class="title-and-btns">
                    <button class="btn-inline btn-copy">å¤åˆ¶</button>
                    <button class="btn-inline btn-show">æ˜¾ç¤º</button>
                    <span class="card-title">******</span>
                    </div>
                    <div class="card-time">${createTime}</div>
                </div>
                <div class="field field-url">
                    <span class="label">ç½‘å€:</span>
                    <a href="${url}" target="_blank" >${url}</a>
                </div>
                <div class="card-body">
                    <!--  <div><span class="label">ID:</span> <span class="value">${id}</span></div>  -->
                    <div><span class="label">Rules:</span> <span class="value">${rules}</span></div>
                    <div><span class="label">Length:</span> <span class="value">${lengthMin} â€“ ${lengthMax}</span></div>
                </div>
                <button class="btn-edit" title="ç¼–è¾‘">âœ</button>
                <button class="btn-delete" title="åˆ é™¤">ğŸ—‘</button>`;
                const titleSpan = card.querySelector('.card-title');
                const showBtn = card.querySelector('.btn-show');
                const copyBtn = card.querySelector('.btn-copy');
                let hidden = true;

                showBtn.addEventListener('click', () => {
                    hidden = !hidden;
                    titleSpan.innerText = hidden ? '******' : content;
                    showBtn.innerText = hidden ? 'æ˜¾ç¤º' : 'éšè—';
                });

                copyBtn.addEventListener('click', async () => {
                    await navigator.clipboard.writeText(content);
                    copyBtn.innerText = 'å·²å¤åˆ¶';
                    await window.electronAPI.showTip('success', 'å·²å¤åˆ¶ï¼');
                    setTimeout(async () => {
                        copyBtn.innerText = 'å¤åˆ¶'
                    }, 1000);
                });
                card.addEventListener('dblclick', async () => {
                    // ç‚¹å‡»å¡ç‰‡æ—¶ï¼Œæ‰“å¼€ç¼–è¾‘çª—å£
                    console.log('ä½ å¥½');
                    // await window.electronAPI.openAddPasswordWindow(item);
                    await navigator.clipboard.writeText(content);
                    await window.electronAPI.showTip('success', 'å·²å¤åˆ¶ï¼');
                });
                card.querySelector('.btn-edit').addEventListener('click', (event) => {
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    // è¿™é‡Œæ”¾ç¼–è¾‘é€»è¾‘ï¼Œæ¯”å¦‚æ‰“å¼€ç¼–è¾‘çª—å£
                    window.electronAPI.openAddPasswordWindow(item);
                });
                card.querySelector('.btn-delete').addEventListener('click', async (event) => {
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    let res = await window.electronAPI.showConfirm({
                        title: 'ç¡®è®¤åˆ é™¤è®°å½•',
                        message: 'ä½ ç¡®å®šè¦åˆ é™¤è¯¥è®°å½•å—ï¼Ÿ',
                        detail: 'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ï¼ï¼',
                    });
                    if (res) {
                        window.electronAPI.deletePwdRecord(item)
                        window.electronAPI.showTip('success', 'åˆ é™¤æˆåŠŸï¼');
                        // TODO: è¿™é‡Œåç»­äº¤ç»™åŒæ„åˆ·æ–°æ¥åš
                        container.removeChild(card);
                    } else {
                        window.electronAPI.showTip('error', 'åˆ é™¤å¤±è´¥ï¼Œç”¨æˆ·å–æ¶ˆæ“ä½œï¼');
                    }
                });

                card.title = "åŒå‡»ä»¥å¤åˆ¶"
                container.appendChild(card);
            });

        }

    </script>

</body>

</html>