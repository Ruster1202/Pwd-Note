<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>密码本</title>
    <link rel="stylesheet" href="./pwd-list-style.css">
</head>

<body>
    <!-- notyf资源挂载 -->
    <link rel="stylesheet" href="node_modules/notyf/notyf.min.css">
    <div id="list">正在加载数据...</div>
    <!-- 固定浮动按钮 -->
    <div class="fab-container" id="fabAdd">
        <div class="fab-button">+</div>
    </div>
    
    <!-- 导出按钮 -->
    <div class="fab-container" id="fabExport">
        <div class="fab-button">⤓</div>
    </div>
    
    <!-- 导入按钮 -->
    <div class="fab-container" id="fabImport">
        <div class="fab-button">⤒</div>
    </div>
    <!-- <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 在这里处理“加载页面”事件，比如从服务器获取数据
            // 主动请求发起数据
            await  window.electronAPI.loadPasswordList(); // 可根据具体实现修改
        });
    </script> -->
    <script>
        document.getElementById('fabAdd').addEventListener('click', () => {
            // 在这里处理“添加密码”事件，比如打开一个IPC窗口或弹窗
            window.electronAPI.openAddPasswordWindow(null); // 可根据具体实现修改
        });
        
        // 导出按钮点击事件
        document.getElementById('fabExport').addEventListener('click', async () => {
            try {
                // 获取密码列表
                const store = await window.electronAPI.showStore();
                const passwordRecords = store.pwdRecords || [];
                
                if (passwordRecords.length === 0) {
                    window.electronAPI.showTip('error', '没有可导出的密码记录');
                    return;
                }
                
                // 调用主进程的导出功能
                const result = await window.electronAPI.exportPasswords(passwordRecords);
                if (result) {
                    window.electronAPI.showTip('success', '密码导出成功');
                }
            } catch (error) {
                console.error('导出密码失败:', error);
                window.electronAPI.showTip('error', '导出密码失败');
            }
        });
        
        // 导入按钮点击事件
        document.getElementById('fabImport').addEventListener('click', async () => {
            try {
                // 调用主进程的导入功能
                const result = await window.electronAPI.importPasswords();
                if (result) {
                    window.electronAPI.showTip('success', '密码导入成功');
                    // 刷新页面以显示新导入的密码
                    location.reload();
                }
            } catch (error) {
                console.error('导入密码失败:', error);
                window.electronAPI.showTip('error', '导入密码失败');
            }
        });
    </script>
    <script type="module">
        // FIX:左括号< 注入BUG
        function escapeHtml(str) {
            if (typeof str !== 'string') return str;
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/`/g, '&#096;');
        }
        // 规则标签名称转换
        const ruleLabels = {
            uppercaseChars: '大写',
            lowercaseChars: '小写',
            numberChars: '数字',
            symbolChars: '符号',
            custom: '自定义',
        };
        const container = document.getElementById('list');
        container.innerHTML = '';

        let list = await window.electronAPI.showStore();
        list = list.pwdRecords
        console.log('查看list', list);
        if (!list || list.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'empty-state ';
            placeholder.innerText = '暂未保存密码记录';
            container.appendChild(placeholder);
        } else {
            list.forEach(item => {
                const content = escapeHtml(item.content);
                const createTime = escapeHtml(item.createTime);
                const id = escapeHtml(item.id);
                const rules = escapeHtml(item.rules.map(ruleKey => ruleLabels[ruleKey]).join(', '))
                const lengthMin = escapeHtml(String(item.length.minLength));
                const lengthMax = escapeHtml(String(item.length.maxLength));
                const url = escapeHtml(item.url ? item.url : '');

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                <div class="card-header">
                    <div class="title-and-btns">
                    <button class="btn-inline btn-copy">复制</button>
                    <button class="btn-inline btn-show">显示</button>
                    <span class="card-title">******</span>
                    </div>
                    <div class="card-time">${createTime}</div>
                </div>
                <div class="field field-url">
                    <span class="label">网址:</span>
                    <a href="${url}" target="_blank" >${url}</a>
                </div>
                <div class="card-body">
                    <!--  <div><span class="label">ID:</span> <span class="value">${id}</span></div>  -->
                    <div><span class="label">Rules:</span> <span class="value">${rules}</span></div>
                    <div><span class="label">Length:</span> <span class="value">${lengthMin} – ${lengthMax}</span></div>
                </div>
                <button class="btn-edit" title="编辑">✎</button>
                <button class="btn-delete" title="删除">🗑</button>`;
                const titleSpan = card.querySelector('.card-title');
                const showBtn = card.querySelector('.btn-show');
                const copyBtn = card.querySelector('.btn-copy');
                let hidden = true;

                showBtn.addEventListener('click', () => {
                    hidden = !hidden;
                    titleSpan.innerText = hidden ? '******' : content;
                    showBtn.innerText = hidden ? '显示' : '隐藏';
                });

                copyBtn.addEventListener('click', async () => {
                    await navigator.clipboard.writeText(content);
                    copyBtn.innerText = '已复制';
                    await window.electronAPI.showTip('success', '已复制！');
                    setTimeout(async () => {
                        copyBtn.innerText = '复制'
                    }, 1000);
                });
                card.addEventListener('dblclick', async () => {
                    // 点击卡片时，打开编辑窗口
                    console.log('你好');
                    // await window.electronAPI.openAddPasswordWindow(item);
                    await navigator.clipboard.writeText(content);
                    await window.electronAPI.showTip('success', '已复制！');
                });
                card.querySelector('.btn-edit').addEventListener('click', (event) => {
                    event.stopPropagation(); // 阻止事件冒泡
                    // 这里放编辑逻辑，比如打开编辑窗口
                    window.electronAPI.openAddPasswordWindow(item);
                });
                card.querySelector('.btn-delete').addEventListener('click', async (event) => {
                    event.stopPropagation(); // 阻止事件冒泡
                    let res = await window.electronAPI.showConfirm({
                        title: '确认删除记录',
                        message: '你确定要删除该记录吗？',
                        detail: '此操作不可撤销！！！',
                    });
                    if (res) {
                        window.electronAPI.deletePwdRecord(item)
                        window.electronAPI.showTip('success', '删除成功！');
                        // TODO: 这里后续交给同意刷新来做
                        container.removeChild(card);
                    } else {
                        window.electronAPI.showTip('error', '删除失败，用户取消操作！');
                    }
                });

                card.title = "双击以复制"
                container.appendChild(card);
            });

        }

    </script>

</body>

</html>